/*
 * hstrings is a reimagination of the strings program, where each
 * found string is scored higher if the characters resemble the
 * distribution of "human" words, and scores lower if not.
 *
 * Only ascii, and the scoring is based on english character frequencies.
 *
 * ./hstrings < some.bin | sort -n
 *
 * First version: 2025-01-25
 * Updated      : 2025-02-02
 * Xabier Saez de Camara
 */

#include <ctype.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

#define MAX_CANDIDATE_BUFFSIZE 2 * 1024
#define MIN_LEN 4

static int total_chars = 0;

/*
 * array from 'a' to 'z', the value of each item is log(freq), where
 * freq is the frequency probability of the correspondig character in
 * english from: https://norvig.com/mayzner.html
 */
static double monogram_logprob[26] = {-2.5207880126916944, -4.210123209982235,  // a, b
                                      -3.3977237942152394, -3.2658716631104365,
                                      -2.080002929445099,  -3.7288412656987924,
                                      -3.9798219713001455, -2.9850142966645783,
                                      -2.5812163187008044, -6.4380603740059845,
                                      -5.218421452935649,  -3.2017928064259142,
                                      -3.684287923565679,  -2.6263424583414015,
                                      -2.571622149166775,  -3.8464782839788487,
                                      -6.719911526146972,  -2.7677737529686635,
                                      -2.7313582355660975, -2.3779198895547475,
                                      -3.6007275596545294, -4.554185615870123,
                                      -4.0891945284479325, -6.0502948429972205,
                                      -4.095917242842809,  -7.015375739040808}; // y, z

/*
 * bigram log probabilities.
 * from: https://norvig.com/mayzner.html
 */
static double bigram_logprob[26][26] = {
  {-8.110130404045705,  -3.713235907890274,  -3.0461015445946114, // aa, ab, ac
   -3.2424216621356634, -6.632970398838929,  -4.843523708707193,
   -3.8287190061907226, -6.537137978576388,  -3.393228017739065,
   -6.686309091010436,  -4.499293538386773,  -2.1587958128874907,
   -3.4983673790854124, -1.5569358637966493, -7.618657420836259,
   -3.837939546722759,  -8.341956332398416,  -2.170404670959076,
   -2.380635040268757,  -1.8460502605177487, -4.370987295008695,
   -3.827704790306882,  -5.057438178505408,  -6.2144368800670815,
   -3.768827357863246,  -6.676445318007567},
  {-2.534612048537505,  -5.12782282772553,   -6.883295261727474,  // ba, bb, bc
   -6.6137430720093775, -1.163018033362597,  -9.445714848358707,
   -8.884287544388874,  -7.464381489336394,  -2.8505616546264863,
   -4.374409709063267,  -9.888234456046307,  -2.066863681611015,
   -6.378888029327855,  -6.7802307463518545, -2.2445155039951645,
   -8.12268512533259,   -11.91867569607012,  -2.8050569008866124,
   -3.6946267808980684, -4.680310332242412,  -2.2995640107527446,
   -6.173130211919193,  -8.740174042068483,  -11.109050139946484,
   -2.3464761447483253, -10.851473606602282},
  {-2.022431747970805,  -8.773303168971147,  -3.890089969498216,
   -7.508157575078371,  -1.831444729303673,  -7.968337921817079,
   -8.431895421916973,  -1.9173959413095538, -2.6705168156944965,
   -10.56391677205446,  -3.5430841212011264, -3.3065727917329193,
   -7.33037978940909,   -8.461395879885275,  -1.6336885007598032,
   -8.037059195419015,  -6.610487184357305,  -3.303594375056944,
   -5.1828279235492385, -2.1772585005845952, -3.219216124484831,
   -9.880044086445057,  -10.2864590600135,   -11.781347051188687,
   -4.579647855139263,  -8.624424047833353},
  {-2.674307297767856,  -6.672090700020162,  -6.768132162907929,
   -3.9366299421669875, -1.0523947462579881, -6.670081611886955,
   -4.257939899410325,  -5.998548995683088,  -1.491592127250377,
   -6.127200552306122,  -8.78057270593956,   -4.215720059130169,
   -4.7918905653003225, -5.667918910327148,  -2.454342125477619,
   -7.142365783602718,  -8.039114810083799,  -3.2441028562999494,
   -2.8536845352230342, -6.628814179417157,  -2.6917123989328395,
   -4.744824486261072,  -5.592493941294578,  -10.771739260306047,
   -3.7715909038780016, -10.242458260790864},
  {-2.7228202737757528, -5.958291164509906,  -3.088740312917515,
   -2.1936955511216745, -3.3229995723146954, -4.164743946886524,
   -4.47323062880459,   -5.986379025280272,  -4.045443413085928,
   -7.742502448668515,  -6.455199366783392,  -2.983403505930264,
   -3.3334932999144855, -1.974604808359699,  -4.973256454248892,
   -4.111836190835451,  -5.209387498669119,  -1.6321010488862067,
   -2.0568769640010207, -3.2343507539408103, -5.817947295694334,
   -3.7164343191317517, -4.496336774819548,  -3.8906649705414913,
   -4.288803379590724,  -7.747620152432765},
  {-2.392019131263059,  -8.785868883409455,  -8.04272364020115,
   -8.194401290439323,  -2.0256265958028097, -2.506111629327012,
   -8.16215685275526,   -9.188956032569369,  -1.8408500677360042,
   -10.10574532419704,  -9.639224500650739,  -3.3189614088465054,
   -7.868871053022732,  -8.361034297133168,  -1.3020739547035773,
   -8.996444128063864,  -12.732013889566906, -2.1297069607424812,
   -5.785406365227104,  -3.0892665199421545, -2.9277974423342203,
   -11.045150315016814, -8.966772299399922,  -11.039198758218783,
   -5.283821527609462,  -12.163423285864576},
  {-2.3719612559310908, -8.073786125556738,  -8.844031284578486,
   -6.2192749413505695, -1.4159586626516538, -7.183638498712345,
   -4.160677510923746,  -1.9425291077419247, -2.3482075024653772,
   -10.61994470702428,  -8.715708383382927,  -3.264792764630319,
   -5.081395657210311,  -3.185522542147244,  -2.485924419528842,
   -8.256776195386932,  -11.771300333475834, -2.0876186082064847,
   -3.4340879394239665, -4.635155216820205,  -2.9180305506370736,
   -10.532956964963141, -7.804135247632746,  -11.294032713998044,
   -4.113908649117226,  -9.475988227897245},
  {-1.812499128173037,  -7.163828073710902,  -8.437555265400484,
   -7.593512868301529,  -0.6121419665296968, -7.8352264845422726,
   -9.929511900374338,  -9.292405327828241,  -2.0055430883289405,
   -11.733610482165512, -10.095916134362335, -6.110062856212415,
   -6.098116942378042,  -5.3943736190977205, -2.45917104448541,
   -9.167143514421568,  -9.50365377255472,   -4.207639038100012,
   -5.9563478916943255, -3.774154748209179,  -4.343213413138648,
   -10.14288282383685,  -7.079900235970451,  -13.314137950104904,
   -4.729314774927622,  -9.609278531466561},
  {-3.488043601180042,  -4.553922106889754,  -2.59579027641896,
   -3.456340386539203,  -3.1926980195520223, -3.830553653690182,
   -3.6039103763201243, -8.40725803391535,   -6.019038573513453,
   -9.039825452754009,  -5.385853620096262,  -3.077674724966752,
   -3.3837262458926736, -1.3482468107952177, -2.4176723526903054,
   -4.654015793117992,  -6.719887101094392,  -3.3919026755027604,
   -2.116439997349858,  -2.1210197788395044, -6.2880354918611765,
   -3.482589134808884,  -9.615646146651484,  -6.052526882310479,
   -10.652029405117895, -4.9808447654386905},
  {-2.0199236216093714, -7.857584694434067,  -7.374211139975757,
   -7.650560754996733,  -1.3236009763878034, -7.7273766064227045,
   -8.577576261390814,  -7.34722651116049,   -4.256456626969764,
   -7.519974543229741,  -8.057919517995899,  -7.451130947133207,
   -7.314543608628415,  -7.18855877782616,   -1.2875972249755494,
   -6.798776531275815,  -17.74526039592286,  -6.688132099675156,
   -7.4091976917157725, -7.541034021375462,  -1.2001975454867926,
   -8.069716089272987,  -8.45837573630689,   -10.433584410683931,
   -8.49835507781254,   -10.122945313158644},
  {-3.3253450905322346, -6.260162045005637,  -7.650483838585532,
   -6.556270912075606,  -0.7910618520407134, -5.693849315588083,
   -5.214778286022806,  -4.997442222418986,  -1.5722268235995052,
   -8.250666032954756,  -6.947065563243191,  -3.7979502796963995,
   -5.574188155346207,  -2.215559673074269,  -4.351593325502784,
   -6.475087789561979,  -11.170508822302972, -5.154688130072285,
   -2.295036026225955,  -6.123312036064911,  -5.048818737236915,
   -8.010156667181745,  -5.377476293754481,  -10.083182534976807,
   -4.372610766125846,  -11.387221551757179},
  {-2.081383916296345,  -6.448930529066039,  -5.87963388921014,
   -2.81775613731754,   -1.629061813659778,  -4.370339091048129,
   -6.54329045437486,   -7.86794019013832,   -1.912873991296311,
   -10.535112109310806, -5.368233170374332,  -1.9924899769721347,
   -5.213185257222596,  -6.579761948169954,  -2.3914631749859545,
   -5.403546347059567,  -10.412610112993384, -6.041889754384213,
   -3.397193540676133,  -3.532237942159518,  -3.442912153050446,
   -4.796932359909291,  -5.812809922473297,  -9.535580790285808,
   -2.2974676276018293, -9.223424876287757},
  {-1.5775435966684566, -3.4122011489311714, -6.453382318376829,
   -8.313352206518275,  -1.2390145313243592, -6.5750289296497515,
   -7.71201646881347,   -8.543740829781976,  -2.1537655568676968,
   -10.181326680807931, -9.878591753780999,  -6.387369370942575,
   -3.3497791229474547, -5.741223255664305,  -2.0951262053712987,
   -2.437649485268133,  -11.598760842375743, -6.781492226831451,
   -3.384041968392877,  -7.6023851831323155, -3.1732364255288443,
   -9.153269205630409,  -8.45278974994293,   -11.259730460562462,
   -3.7847093911126004, -11.284216875979286},
  {-2.957748299600841,  -7.340812017741655,  -2.777675886057201,
   -1.5982016006333777, -2.2685654816657363, -4.600363580934898,
   -1.94811952794529,   -6.420482716149073,  -2.981123316986516,
   -6.402031234587242,  -4.864122430619568,  -4.652249089255432,
   -5.484532698746831,  -4.520519128193561,  -2.666627087272878,
   -7.010057151000833,  -7.024356615818111,  -6.593805175996485,
   -2.575424880943368,  -1.859571706479956,  -4.442812882398704,
   -4.856368829029547,  -7.050408580633289,  -7.844245331148697,
   -4.223625279435141,  -7.33320072604479},
  {-5.0026633792498485, -4.482894397925462,  -3.939780880905927,
   -3.7789043008519214, -5.400159576878951,  -1.9852035837978819,
   -4.51065366688253,   -5.992949500285032,  -4.57970560027861,
   -7.111745658931881,  -4.890462766530358,  -3.152959807530748,
   -2.751116622166332,  -1.5822474882764526, -3.7058648360647988,
   -3.6429570904025512, -9.01829293600598,   -1.9022981359834121,
   -3.384439650610511,  -2.962662411744053,  -2.285710095171548,
   -3.8719363327535183, -3.2536657549142856, -6.132367164657523,
   -5.465664006730078,  -7.809410808858608},
  {-2.0669715473046324, -7.577345008628491,  -7.684353291369767,
   -7.66518431976203,   -1.6768065509447574, -7.471482154426261,
   -8.59370982136344,   -3.2989593132460637, -3.033445515617509,
   -10.152137539275822, -8.045787746546175,  -2.2742897392437387,
   -5.076549473212382,  -7.6729737384556405, -1.956483488171163,
   -2.929736044671367,  -11.11323083182324,  -1.6841943358413562,
   -3.846888635077089,  -3.1850130221088655, -3.196822922629517,
   -9.357490246280529,  -7.658135390934667,  -10.797978267799959,
   -5.381371687062138,  -9.332084208255878},
  {-6.884520867026987,  -8.262595133497381,  -8.222825857148345,
   -8.996817468841726,  -8.900581178645936,  -8.39626748882089,
   -17.476118397656716, -9.676406822802946,  -6.150569801621191,
   -9.78273804828782,   -17.476118397656716, -6.439301231643119,
   -8.352922744893174,  -7.722264734846906,  -8.061807477695057,
   -9.644030733666625,  -7.804948876717499,  -7.786371405480466,
   -6.850149177299626,  -8.01667437269679,   -0.009428340097524357,
   -8.796060225514225,  -10.15495433661212,  -10.178419076102852,
   -17.476118397656716, -17.476118397656716},
  {-2.230532122150116,  -5.475753364177387,  -3.961893839484562,
   -3.5174550577137924, -1.235599615235223,  -5.287033727847022,
   -4.157972549948997,  -6.0454132784891765, -2.17109729120883,
   -9.352933805228766,  -4.185809656114437,  -4.303454376906205,
   -3.5953294129308015, -3.683446824867432,  -2.1723272975342693,
   -5.032295198865385,  -8.762438329528116,  -3.9672098933689157,
   -2.7781298328457638, -2.870124743114345,  -3.906279282724745,
   -4.522670673012073,  -6.214766146656047,  -8.603854016677799,
   -3.248494367293787,  -9.210087175911259},
  {-3.097406442779293,  -6.413060532023351,  -3.4401746274861247,
   -6.822113789758023,  -1.6445257824443298, -5.639140503718793,
   -7.57858196241464,   -2.728647263805722,  -2.171959178784485,
   -9.790165215921036,  -4.806575119484788,  -4.458762825670957,
   -4.304537025319861,  -6.265503935582801,  -2.4962027188649087,
   -3.2283779849179726, -6.474580369517922,  -6.691898796668525,
   -2.477908777940601,  -1.5221314012596354, -2.7416211429998194,
   -8.265692893433812,  -5.3237817711439535, -12.506815438917982,
   -4.44165829495414,   -9.869426353875388},
  {-2.871109895679072,  -8.209839902507374,  -5.880447437003896,
   -8.88458019321907,   -2.049645265531528,  -7.410136977528443,
   -8.466179200097084,  -0.9673231277277723, -1.9414243843169363,
   -11.329350638483634, -9.911737782546748,  -4.554231425588929,
   -5.867416607036844,  -6.840122216968293,  -2.195578849335738,
   -7.686445292680741,  -11.559747711242064, -3.08975477785031,
   -3.3222413339688193, -4.003962109681816,  -3.602874245882276,
   -8.992370498730828,  -4.732523524381225,  -11.280333015825635,
   -3.717601936139935,  -7.795970368460111},
  {-3.200813987115317,  -3.632006401252823,  -2.8813256843211192,
   -3.600654524740011,  -3.122221337325899,  -5.19640210721514,
   -3.2646083272304907, -8.050688065328442,  -3.4992789521193606,
   -8.777663504283298,  -6.58897057581029,   -2.2699704039001216,
   -3.1858938395237484, -2.138517563872269,  -5.749723697253839,
   -3.2031695976005308, -9.476087842323187,  -1.8192715438759952,
   -1.997253017592045,  -2.1116557660098403, -8.363762867771126,
   -7.045326708294376,  -9.397858333282247,  -6.746059167138128,
   -6.59699358317843,   -7.468474351038343},
  {-2.241339427786032,  -9.607346872119626,   -8.63939949244282,
   -8.39020577719177,   -0.46711610706222956, -10.083582505435821,
   -9.436762126807475,  -9.532100074753494,   -1.5861065771333256,
   -10.844494898999537, -11.608098375809755,  -8.069226490374863,
   -9.365719696014517,  -9.05930240311016,    -2.9186511310333456,
   -8.815468959998112,  -12.069181329825312,  -7.315188567750053,
   -7.733134093416406,  -8.700411087612489,   -6.388718239876218,
   -9.557886797260359,  -10.820194630220529,  -11.320874124891139,
   -5.594170965970528,  -11.212813935112923},
  {-1.5960767734159418, -7.490565979857237,  -7.944524359580224,
   -6.286555567372508,  -1.6615964641022078, -7.07541644528137,
   -9.87714860024784,   -1.6132042288680395, -1.6248152094139856,
   -10.97912654971764,  -7.4850142645573134, -4.8275076864756645,
   -7.464085659354443,  -3.1809044106893634, -2.1486251696894922,
   -7.845706716190237,  -20.022776996305844, -4.123942385501387,
   -3.992446871282462,  -5.672039073552534,  -7.913783561986365,
   -11.833257455435952, -8.890946707635539,  -12.782279975326546,
   -6.664478847391437,  -20.022776996305844},
  {-2.146607327861967,  -8.101326670129037,  -2.2587916763663025,
   -10.655846588246806, -2.452756712492098,  -4.9152046924740915,
   -9.485098258996807,  -4.106171793418975,  -1.8601865267573232,
   -9.54486042595086,   -10.14211308862165,  -6.056520275086218,
   -6.991224132340415,  -8.395145016088238,  -4.541608293678193,
   -1.3317589298613521, -6.766376079076498,  -8.970781534131046,
   -8.283203003689763,  -1.6915186078518427, -3.971845988187304,
   -4.864892509218887,  -7.034257119774746,  -4.503308187817039,
   -4.588023454536954,  -10.86489637081428},
  {-3.497491371569065,  -4.7969248264491124, -3.652603758813751,
   -4.335765628538757,  -1.7263060214887431, -6.538339243294134,
   -5.302675821237642,  -6.907855201340531,  -2.894275385392923,
   -10.171977052517004, -7.3653212046203445, -3.5636547732605286,
   -3.0909207916704498, -3.6740449830340336, -1.245356304808362,
   -3.0398925429772103, -10.54935635249636,  -4.20229095997162,
   -1.6823552229428531, -3.440890992730128,  -5.9718987816614115,
   -7.962211309927337,  -5.039921596492859,  -8.156792124305827,
   -8.90488829626801,   -5.660793429617908},
  {-1.4399506702782936, -6.226323664572728,  -7.251851134910794,
   -7.647027092996983,  -0.7483055986019035, -8.491108730419587,
   -6.440950590413392,  -5.061231165629817,  -2.1603190896075968,
   -9.168488086804198,  -8.092291364742415,  -4.4258514390325425,
   -6.4437142869474515, -6.535431520768216,  -2.6835242915090216,
   -7.685326799130366,  -8.08514790016421,   -6.322597264414142,
   -5.866423963571931,  -6.102963056382412,  -3.88834209864874,
   -6.4640535686776435, -6.156911651699843,  -10.217720057154773,
   -3.7973692530589904, -3.6765118986783305}};

int get_candidate(char *candidate, int limit);
int is_candidate_char(int c);
int trim(char s[]);
int compress_blank(char s[]);
int clean_string(char s[]);
double score_candidate_monogram(char *candidate);
double score_candidate_bigram(char *candidate);

int main(int argc, char *argv[])
{
  int retval = 0;
  int min_length = MIN_LEN;
  int candidate_len = 0;
  char candidate[MAX_CANDIDATE_BUFFSIZE];
  char processed[MAX_CANDIDATE_BUFFSIZE];

  int is_bigram = 1;
  double score;

  int opt;
  while ((opt = getopt(argc, argv, "n:m")) != -1) {
    switch (opt) {
    case 'n':
      min_length = atoi(optarg);
      break;
    case 'm':
      is_bigram = 0;
      break;
    case '?':
      return 1;
      break;
    }
  }

  if (min_length < 1) {
    printf("hstrings: minimum string length is too small: %d\n", min_length);
    return 1;
  } else if (min_length > MAX_CANDIDATE_BUFFSIZE) {
    printf("hstrings: minimum string length is too big: %d\n", min_length);
    return 1;
  }

  while ((candidate_len = get_candidate(candidate, MAX_CANDIDATE_BUFFSIZE)) != EOF) {
    if (candidate_len >= min_length) {

      strcpy(processed, candidate);
      int processed_len = clean_string(processed);
      /* trim(processed); */
      /* compress_blank(processed); */

      if (is_bigram) {
	score = processed_len >= min_length? score_candidate_bigram(processed): -21.0;
      } else {
	score = processed_len >= min_length? score_candidate_monogram(processed): -8.0;
      }

      printf("%.6f: %s\n", score, candidate);
    }
    if (candidate_len == MAX_CANDIDATE_BUFFSIZE) {
      retval = 1;
    }
  }

  printf("hstrings: Read %d\n", total_chars);
  if (retval != 0) {
    printf("hstrings: Warning. Some lines were truncated\n");
  }
  return retval;
}

int get_candidate(char *candidate, int limit)
{
  int c;
  int i = 0;

  while ((c = getchar()) != EOF && limit > 0) {
    total_chars++;
    if (is_candidate_char(c)) {
      candidate[i++] = (char) c;
      limit--;
    } else {
      break;
    }
  }

  candidate[i] = '\0';
  return c == EOF? EOF : i;
}

int is_candidate_char(int c)
{
  return isprint(c);
}

int trim(char s[])
{
  int r = 0, w = 0;

  // trim left
  while (isspace(s[r])) {
    r++;
  }

  for (; s[r] != '\0'; r++) {
    s[w++] = s[r];
  }

  // trim right
  r = w;
  for (r--; isspace(s[r]) && r >= 0; r--) {
    w--;
  }

  s[w] = '\0';
  return w;
}

int compress_blank(char s[])
{
  int r, w;
  int was_space = 0;

  for (r = w = 0; s[r] != '\0'; r++) {
    if (isspace(s[r])) {
      if (was_space) {
	continue;
      } else {
	// convert any whitespace to space
	s[w++] = ' ';
	was_space = 1;
      }
    } else {
      s[w++] = s[r];
      was_space = 0;
    }
  }
  s[w] = '\0';
  return w;
}

int clean_string(char s[])
{
  int r, w;
  for (r = w = 0; s[r] != '\0'; r++) {
    if (isspace(s[r]) || s[r] == '.' || s[r] == '_' || s[r] == '-' || s[r] == '/') {
      continue;
    }
    s[w++] = s[r];
  }
  s[w] = '\0';
  return w;
}

double score_candidate_monogram(char *candidate)
{
  double score = 0;
  int i;

  for (i = 0; candidate[i] != '\0'; i++) {
    if (isalpha(candidate[i])) {
      score += monogram_logprob[tolower(candidate[i]) - 'a'];
    } else {
      score -= 8.0;
    }
  }

  return i == 0? -8.0 : score/i;
}

double score_candidate_bigram(char *candidate)
{
  double score = 0;
  int i = 0;
  int b1, b2;

  b2 = candidate[i++];

  for (; candidate[i] != '\0'; i++) {
    b1 = b2;
    b2 = candidate[i];
    if (isalpha(b1) && isalpha(b2)) {
      score += bigram_logprob[tolower(b1) - 'a'][tolower(b2) - 'a'];
    } else {
      score -= 21.0;
    }
  }

  return i == 0? -21.0 : score/i;
}
